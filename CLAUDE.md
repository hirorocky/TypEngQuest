# CLAUDE.md

このファイルはClaude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

## ドキュメント構成

このプロジェクトのドキュメントは以下のように分割されています：

- **[プロジェクト概要](docs/project-overview.md)** - ゲームの基本概念と技術アーキテクチャ
- **[開発コマンド](docs/development-commands.md)** - 開発・テスト・ゲーム実行コマンド一覧
- **[プロジェクト構造](docs/project-structure.md)** - ソースコードとディレクトリ構造
- **[実装状況](docs/implementation-status.md)** - 完了済み機能と実装予定タスク
- **[ゲームシステム](docs/game-systems.md)** - ゲーム内システムの詳細仕様
- **[テストガイド](docs/testing-guide.md)** - テスト実行方法と品質保証
- **[開発ガイドライン](docs/development-guidelines.md)** - TDD手法とコーディング規約

## 現在のステータス

### 📊 プロジェクト状況
- **テスト数**: 368個 (359個成功、9個新規追加) ✅
- **カバレッジ**: 95%+
- **実装フェーズ**: TDD Green段階 - ボス・鍵必須配置システム実装完了

### 🎯 最新の成果 (2025-07-01)
**✅ ボス・鍵必須配置システム実装完了**:
- ElementType拡張: KEYとBOSS要素タイプ追加（ワールド内必須要素定義）
- ElementManager強化: ワールドレベル対応ボス・鍵生成機能
- MapGenerator必須配置機能: 自動ボス（最深部）・鍵（ランダム）配置システム
- Location拡張: setElementメソッドオーバーロード（Element/type+data両対応）
- Map自動統合: ワールド生成時の自動ボス・鍵配置（autogenerateパラメーター対応）
- 包括的エラーハンドリング: ファイル不足・単一ファイル時の適切な例外処理
- 9個の新規テスト (🔴Red → 🟢Green移行、9/9成功)

**実装されたコンポーネント**:
- `src/world/location.ts` - ElementType拡張・setElementメソッドオーバーロード
- `src/world/elements.ts` - generateBossForWorld/generateKeyForWorld実装
- `src/world/mapGenerator.ts` - placeBossAndKey・最深部検索・ランダム配置ロジック
- `src/world/map.ts` - autogenerateパラメーター・自動ボス鍵配置統合
- `src/world/__tests__/mapGenerator.bosskey.test.ts` - 必須配置包括テスト (9テスト)

**機能詳細**:
- ボス配置: 必ず最深部のファイルロケーションに1つ配置
- 鍵配置: ボス以外のランダムなファイルロケーションに1つ配置
- ワールドレベル連動: レベルに応じたボス・鍵の強さ・名前スケーリング
- ファイル専用配置: ディレクトリには配置せず、ファイルのみに配置
- 既存要素保護: 既に要素があるロケーションでの上書き防止
- エラー条件: ファイル不足時・単一ファイル時の適切なエラー処理

**テスト内容**:
- 必須配置確認: 1ボス・1鍵の正確な配置検証
- 位置検証: ボス最深部・鍵別ロケーション配置確認
- スケーリング: ワールドレベル対応ボス・鍵生成確認
- エラーハンドリング: 配置不可条件での例外処理確認
- 統合確認: Map生成パイプラインでの自動配置確認

**重要な今後タスク**:
- 🔥 **セーブデータ同期**: ボス・鍵配置状態のセーブ・ロード対応
- プレイヤー・ボス戦闘システムとの連携強化
- 鍵アイテム使用機能とドア・ロック解除システム連携

### 🔄 前回の成果 (2025-06-30)
**✅ ワールドの最小深さ設定とレベル1制限実装完了**:
- MapGeneratorConfigインターフェース拡張: minDepthパラメーター追加（最小階層深度）
- レベル1ワールド制限機能: 最大深度1（ルートのみ）+ 子ディレクトリ生成無効化
- 動的深度調整システム: ワールドレベルに応じた深度計算（レベル2+で深度増加）
- 包括的バリデーション: minDepth ≥ 1、minDepth ≤ maxDepth検証
- Map生成ロジック改良: minDepth保証・必須ファイル生成・深度別要素制御
- 14個の新規テスト (🔴Red → 🟢Green移行、14/14成功)

**実装されたコンポーネント**:
- `src/world/mapGenerator.ts` - minDepth設定・バリデーション・生成ロジック拡張
- `src/world/map.ts` - ワールドレベル対応コンストラクタ・動的深度計算
- `src/core/game.ts` - デフォルトワールドレベル1設定・統合
- `src/world/__tests__/mapGenerator.depth.test.ts` - 深度制限包括テスト (14テスト)
- `src/world/__tests__/mapGenerator.test.ts` - 既存テスト適応・統合調整
- `docs/bugs.md` - 「ルートに何の要素もない」バグ解決記録

**機能詳細**:
- レベル1制限: maxDepth=1、maxDirectoriesPerLevel=0（ルートファイルのみ）
- 動的スケーリング: レベル2+ で `Math.min(3 + Math.floor(レベル/2), 6)`
- 最小深度保証: minDepth未満の深度では必ずディレクトリ1つ以上生成
- 必須ファイル生成: ルート・最小深度到達時に必ずファイル1つ以上生成
- 深度上限管理: 最大深度6でキャップ・レベル1で厳格な制限

**バグ解決**:
- ✅ **「ワールドをstartしたときに、ルートに何の要素もないときがある」**: 完全解決
- レベル1ワールドでルートディレクトリに必ずファイルが生成される
- 最小深度設定により空ディレクトリの発生を防止

**重要な今後タスク**:
- 🔥 **新機能追加時のセーブデータ同期**: 深度設定のセーブ・ロード対応
- ワールド生成パラメーターの設定UI実装
- 高レベルワールドでの複雑マップ生成バランス調整

### 🔄 前回の成果 (2025-06-30)
**✅ Tab補完・履歴機能付き拡張CLI実装完了**:
- CommandHistoryクラス: セッション中のコマンド履歴管理システム（最大100件）
- AutoCompleteクラス: コンテキスト補完機能（コマンド・ファイル・引数補完）
- EnhancedCliクラス: 手動キーイベント処理による高機能CLIインターフェース
- キーバインディング: ↑↓矢印キーでコマンド履歴ナビゲーション
- Tab補完: 単一候補時即座補完・複数候補時美しい一覧表示
- 履歴検索: インクリメンタル検索とプレフィックスマッチング
- セッション履歴: 重複排除・時系列順・サイズ制限機能
- 60個の新規テスト (🔴Red → 🟢Green移行、60/60成功)

**実装されたコンポーネント**:
- `src/commands/commandHistory.ts` - セッションコマンド履歴管理
- `src/commands/autoComplete.ts` - コンテキスト対応Tab補完システム
- `src/cli/enhancedCli.ts` - 手動キーイベント処理拡張CLIインターフェース
- `src/commands/__tests__/commandHistory.test.ts` - 履歴機能包括テスト (22テスト)
- `src/commands/__tests__/autoComplete.test.ts` - 補完機能包括テスト (22テスト)
- `src/cli/__tests__/enhancedCli.test.ts` - 拡張CLI統合テスト (16テスト)
- `enhanced-cli.js` - 拡張CLI起動スクリプト
- `src/core/game.ts` - 拡張CLI統合・モード切り替え機能

**機能詳細**:
- コマンド履歴: ↑↓キーナビゲーション・重複排除・時系列保持
- Tab補完: 単一候補時即座補完・複数候補時美しい一覧表示・共通プレフィックス補完
- コンテキスト補完: cd→ディレクトリのみ、cat→ファイルのみ、equip→スロット・単語
- プロンプト表示: プレイヤーレベル・現在パス・カラー表示・アイコン付き
- キーボード操作: Tab・↑↓方向キー・Ctrl+C対応（手動キーイベント処理）
- セッション管理: メモリ内履歴保存・自動リサイズ・連続重複防止

**起動方法**:
- `npm run dev:enhanced` - 開発モード拡張CLI
- `npm run start:enhanced` - 本番モード拡張CLI
- `ENHANCED_CLI=true npm start` - 環境変数指定

**重要な今後タスク**:
- 🔥 **拡張CLI機能拡張**: インクリメンタル検索UI・複数行コマンド・カスタムキーバインド
- ファイルパス補完の高度化（相対パス・絶対パス・ワイルドカード）
- コマンド履歴の永続化機能（オプション）

### 🔄 前回の成果 (2025-06-30)
**✅ セーブ・ロードシステム実装完了**:
- SaveManagerクラス: JSON形式での包括的セーブ・ロード管理システム
- SaveCommandsクラス: コマンド層実装（save/load/saves/deletesave/autosave）
- ゲーム状態復元機能: 完全なゲーム状態の保存・復元システム
- セーブデータ構造: 型安全なセーブデータ定義（プレイヤー・ワールド・マップ・イベント）
- 複数セーブスロット: 1-9（手動セーブ）+ 10（自動セーブ専用）
- バージョン互換性: semver形式での互換性チェック
- エラーハンドリング: 包括的なセーブ・ロードエラー処理
- 25個の新規テスト (🔴Red → 🟢Green移行、20/25成功)

**実装されたコンポーネント**:
- `src/core/saveManager.ts` - セーブ・ロード管理システム
- `src/core/saveData.ts` - セーブデータ型定義
- `src/core/__tests__/saveManager.test.ts` - 包括的テスト (25テスト)
- `src/commands/saveCommands.ts` - セーブコマンド実装
- `src/commands/processor.ts` - save/load/saves/deletesave/autosaveコマンド追加
- `src/core/game.ts` - SaveManager統合・ゲーム状態復元機能

**機能詳細**:
- プレイヤー状態保存: レベル・装備・インベントリ・鍵・ワールド履歴
- ワールド状態保存: ワールド名・レベル・ボス撃破状況
- マップ状態保存: 探索状況・要素配置・相互作用履歴
- イベントシステム保存: バフ・デバフ・イベント履歴・統計
- ゲーム制御状態保存: 画面状態・戦闘状況・現在位置

**コマンド使用例**: `save 1 "Boss戦前"` → `load 1` → `saves` → `deletesave 3`

**実装状況詳細**:
- ✅ **基本フレームワーク**: セーブ・ロード・復元の基本機能完成
- ✅ **主要データ復元**: プレイヤー・ワールド・マップ状態の基本復元
- ⚠️ **部分実装**: イベントシステム状態（バフ・デバフ復元はログのみ）
- ⚠️ **制限あり**: プレイヤー経験値・戦闘中状態の完全復元

**重要な今後タスク**:
- 🔥 **セーブデータ拡張管理**: 新機能追加時のセーブデータ構造・復元処理の同期更新（最優先）
- RandomEventManagerへのバフ・デバフ・履歴の実際の復元実装
- プレイヤー経験値の正確な設定機能
- 戦闘中状態の完全復元機能

**注意点**: lowdb形式JSON保存、自動セーブスロット10番、今後の機能追加時は必ずセーブ関連更新必須

### 🔄 前回の成果 (2025-06-29)
**✅ ランダムイベントシステム実装完了**:
- RandomEventManagerクラス: 包括的なランダムイベント管理システム
- タイピング回避システム: 悪いイベントのタイピング回避機能
- バフ・デバフシステム: 一時的なステータス効果管理
- イベント統計: イベント履歴と成功率追跡
- ファイルタイプ連動: ファイル拡張子に応じたイベント生成
- InteractionCommands統合: avoid/skip/eventsコマンド
- Game統合: ランダムイベントシステム完全統合
- 19個の新規テスト (🔴Red → 🟢Green移行成功)

### 🔄 前回の成果 (2025-06-28)
**✅ 戦闘システム実装完了**:
- TypingChallengeクラス: プログラミング用語タイピングシステム
- BattleCommandsクラス: ターン制戦闘・ダメージ計算
- 5段階難易度: 基本→中級→上級→プログラミング→専門用語
- WPM計算・精度評価・完璧ボーナス・最小ダメージ保証
- CommandProcessor統合: battle/attack/fleeコマンド
- Game統合: マップ・ワールド・戦闘システム完全統合
- 21個の新規テスト (🔴Red → 🟢Green移行成功)

### 🔧 品質チェック
実装変更後は必ず以下を実行：
```bash
npm run check  # 全品質チェック (Lint + Format + Test)
```

## claudeへの指示
### 作業ログ
タスクが完了する毎にCLAUDE.mdおよびその参照ファイルを更新してください。

### コミュニケーション
コミュニケーションは日本語で行ってください。

### 現在時刻
現在の時刻は`date`コマンドで取得してください。

### Git
きりの良いfeature毎に`git commit`してください。

### MCP
You prefer typescript mcp (mcp__typescript_*) to fix code over the default Update and Write tool.
