# CLAUDE.md

このファイルはClaude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

## プロジェクト概要

**CodeQuest RPG** - エンジニア向けTypeScript CLI ベースのタイピングRPGゲーム。プレイヤーはファイルシステムのようなマップを `cd` コマンドで探索し、プログラミング関連の単語や文章をタイピングして敵と戦い、ドロップした英単語装備を収集して文法的に正しい英文を構成します。

## ゲームデザイン概要

### コア仕組み
- **探索**: ファイルシステムライクなマップを `cd` コマンドで移動
- **マップ生成**: プロジェクト構造風の自動生成マップ（ディレクトリ＆ファイル）
- **戦闘**: 各場所で遭遇する敵とプログラミングキーワードでバトル
- **装備ドロップ**: 敵を倒すと英単語装備がランダムでドロップ
- **装備システム**: 個別のステータス効果を持つ英単語 (ATK, DEF, SPD, ACC, CRT)
- **検証**: 装備した単語は文法的に正しい英文を構成する必要がある
- **コレクション**: より強力な単語を求めてマップを探索し続ける収集要素
- **コマンド**: 全てのユーザー操作はタイプしたコマンドで実行（Unix系OSライク）
- **進行**: タイピング精度と速度、装備収集、マップ探索によってキャラクターが強化

### 技術アーキテクチャ
- **言語**: TypeScript with ES Modules
- **ランタイム**: Node.js 22.17.0 (mise.tomlで管理)
- **CLIフレームワーク**: Commander.js + Inquirer.js
- **UI**: Blessed (ターミナルUI), Chalk (色), CLI-progress
- **データ**: Lowdb (JSONデータベース), Zod (バリデーション)
- **テスト**: Jest + ts-jest (TypeScript対応)
- **品質管理**: ESLint (コード品質), Prettier (コード整形)

## 開発コマンド

```bash
npm run dev          # ホットリロード付き開発
npm run build        # TypeScriptコンパイル
npm run start        # コンパイル済みバージョン実行
npm run watch        # ウォッチモード開発
npm run lint         # ESLintによるコード品質チェック
npm run lint:fix     # ESLintによる自動修正
npm run format       # Prettierによるコード整形
npm run format:check # Prettierによる整形チェック
npm run test         # テスト実行 (Lint・Format自動実行)
npm run test:watch   # テストウォッチモード
npm run test:coverage # カバレッジ付きテスト実行
npm run check        # 全品質チェック (Lint + Format + Test)
```

## プロジェクト構造

```
src/
├── core/                    # ゲームロジック
│   ├── game.ts             # メインゲーム状態
│   ├── player.ts           # プレイヤーステータス/進行
│   ├── combat.ts           # 戦闘システム
│   ├── enemy.ts            # 敵クラス定義
│   ├── loot.ts             # ドロップシステム
│   └── __tests__/          # コアロジックテスト
│       ├── player.test.ts  # プレイヤークラステスト
│       ├── equipment.test.ts # 装備システムテスト
│       ├── combat.test.ts  # 戦闘システムテスト
│       ├── enemy.test.ts   # 敵システムテスト
│       └── loot.test.ts    # ドロップシステムテスト
├── world/                  # ワールド・マップシステム
│   ├── map.ts             # マップ生成・管理
│   ├── location.ts        # 場所クラス定義
│   ├── navigation.ts      # 移動システム
│   ├── elements.ts        # マップ要素（モンスター、宝箱、トラップ等）
│   ├── interaction.ts     # 要素との相互作用システム
│   └── __tests__/         # ワールドシステムテスト
│       ├── map.test.ts    # マップ生成テスト
│       ├── location.test.ts # 場所システムテスト
│       ├── navigation.test.ts # 移動システムテスト
│       ├── elements.test.ts # マップ要素テスト
│       └── interaction.test.ts # 相互作用テスト
├── commands/               # CLIコマンドハンドラー
│   ├── processor.ts        # コマンド処理
│   ├── filesystem.ts      # ファイルシステム風コマンド (cd, ls, pwd等)
│   └── __tests__/          # コマンドテスト
│       ├── processor.test.ts # コマンド処理テスト
│       ├── filesystem.test.ts # ファイルシステムコマンドテスト
│       └── grammar.test.ts  # 文法検証テスト
├── systems/                # ゲームシステム
│   ├── collection.ts       # コレクション管理
│   ├── rarity.ts          # レアリティシステム
│   ├── drops.ts           # ドロップ履歴管理
│   ├── encounter.ts       # エンカウントシステム
│   ├── randomevents.ts    # ランダムイベントシステム
│   ├── typingescape.ts    # タイピング回避システム
│   └── savepoints.ts      # セーブポイントシステム
├── ui/                     # 表示/インターフェース
│   ├── display.ts          # 画面レンダリング
│   ├── battle.ts          # 戦闘画面
│   ├── map.ts            # マップ表示
│   └── input.ts           # 入力処理
└── data/                   # データ管理
    ├── database.ts         # 保存/読み込みシステム
    ├── words.json          # 単語データベース
    ├── enemies.json        # 敵データベース
    ├── drops.json          # ドロップテーブル
    ├── locations.json      # 場所テンプレート
    ├── elements.json       # マップ要素設定
    ├── randomevents.json   # ランダムイベントデータ
    ├── typingchallenges.json # タイピング回避チャレンジデータ
    └── filetypes.json      # ファイルタイプ別設定
```

## 実装状況

### 完了 ✅
1. ゲームデザインと仕組み仕様
2. コマンドベースUI/UX設計
3. ステータス計算付き単語装備システム
4. 技術スタック選択
5. 基本プロジェクトセットアップ (package.json, tsconfig, フォルダー構造)
6. **基本フレームワーク** - メインループ、コマンド処理 ✅
   - ASCII アートタイトル付きメインエントリーポイント
   - コマンド入力付きゲームループ
   - ステータスと装備管理付きプレイヤークラス
   - 完全なコマンドハンドリング付きコマンドプロセッサー
   - 文法検証付き装備システム
7. **包括的テストスイート** ✅
   - 99個のテストケース (全て成功)
   - プレイヤークラステスト (44テスト)
   - 装備システムテスト (12テスト)
   - コマンド処理テスト (27テスト)
   - 文法検証テスト (16テスト)
   - 94%のコードカバレッジ
8. **マップシステム基礎** ✅
   - Location クラス: ファイル・ディレクトリ表現、要素管理、探索状態
   - Map クラス: ファイルシステム風ナビゲーション、パス解決
   - 55個の追加テストケース (全て成功)
   - LocationとMapクラスの完全な機能テスト

### 現在動作中のコマンド
```bash
help          # 利用可能な全コマンドを表示
status        # プレイヤーステータスと装備ボーナスを表示
inventory     # インベントリ内の利用可能な単語を表示
equipment     # 装備中の単語と現在の文章を表示
equip 1 the   # スロット1に単語"the"を装備
unequip 1     # スロット1から単語を削除
validate      # 現在の文章の文法をチェック
start         # アドベンチャー開始
quit          # ゲーム終了
```

### 実装予定のコマンド（マップ・ドロップシステム対応）
```bash
# ファイルシステム風ナビゲーション
pwd           # 現在位置表示 (/projects/web-app/src/)
ls            # 現在ディレクトリの内容表示
ls -la        # 隠しファイルと詳細情報も表示
cd <path>     # 指定パスに移動
cd ..         # 親ディレクトリに移動
tree          # ディレクトリツリー表示
find <name>   # ファイル・ディレクトリ検索

# ファイル調査・相互作用
file <name>   # ファイルタイプ調査（要素のヒント表示）
cat <name>    # ファイル内容表示（イベント・情報確認）
head <name>   # ファイルの先頭部分表示
interact <name> # ファイルと相互作用（戦闘・宝箱・トラップ等実行）

# 探索・戦闘・イベント
explore       # 現在地を詳細探索（隠し要素発見）
battle        # 敵との戦闘開始（ドロップ獲得チャンス）
save          # セーブポイントで回復・データ保存
events        # ランダムイベント一覧・進行状況確認
map           # 現在位置周辺のマップ表示

# コレクション・管理
collection    # 収集した装備の図鑑表示
drops         # 最近のドロップ履歴表示
rarity        # レアリティ別装備一覧
search        # 特定の装備を検索
locations     # 訪問済み場所の一覧
randomevents  # 発生済みランダムイベントの履歴
```

### 次の実装タスク 🚧
1. **マップ・ナビゲーションシステム** - ファイルシステム風マップ生成、cd/ls/pwd コマンド ✅ 基本完了
2. **ワールドシステム** - ボス戦、鍵システム、ワールドクリア・リタイア機能 🚧 進行中
3. **プレイヤー拡張機能** - 鍵管理、ワールド履歴、レベル調整機能 🚧 進行中
4. **マップ要素システム** - モンスター、宝箱、ランダムイベント、セーブポイントの配置
5. **ファイル調査システム** - file, cat, head コマンドによる段階的発見
6. **相互作用システム** - interact コマンドによる要素との相互作用
7. **ランダムイベントシステム** - 良い事・悪い事の統合システム
8. **タイピング回避システム** - 悪いイベントに対する緊急タイピングチャレンジ
9. **セーブ・回復システム** - セーブポイントでの回復とデータ保存
10. **装備ドロップシステム** - 場所依存ドロップ、宝箱システム
11. **戦闘システム** - 場所効果付きタイピングバトル
12. **単語データベース拡張** - ファイルタイプ別専用装備
13. **UI/表示強化** - イベント表示、タイピングチャレンジUI、結果表示
14. **データベース/保存** - マップ状態、イベント履歴、探索履歴
15. **仕上げ** - バランス調整、確率調整、デバッグ

### テスト状況
- **基本フレームワーク**: テスト済みで動作中
- **全コマンド**: 機能確認済み
- **装備システム**: 動作確認済み
- **文法検証**: 動作確認済み
- **初期単語セット**: ['the', 'quick', 'brown', 'fox', 'jumps'] (スターター装備)
- **テストカバレッジ**: 94% (99/99テスト成功)
- **次期テスト対象**: マップシステム、ランダムイベント、タイピング回避システム、戦闘システム

## 主要ゲームシステム

### ワールドシステム ⭐ 新機能
このゲームはワールド単位で進行し、各ワールドにはボスが存在します。

#### ワールドの構造
- **階層構造**: 各ワールドは最大深度を持つファイルシステム風マップ
- **ボス配置**: 最深部（最大深度）にボスディレクトリが存在
- **鍵システム**: ボスディレクトリへのアクセスには鍵が必要
- **クリア条件**: ボスを倒すとワールドクリア

#### ワールド進行システム
- **ワールドクリア後の選択**:
  - レベルアップ（難易度上昇）
  - レベル維持（同難易度継続）
  - レベルダウン（難易度軽減）
- **ワールドリタイア**: いつでも現ワールドを破棄して新ワールド生成可能
- **データ引き継ぎ**: プレイヤーステータス・装備は全て維持
- **履歴保存**: クリアしたワールドの思い出情報のみ保存

#### 鍵システム
- **鍵の入手**: 宝箱から取得
- **所持制限**: 1つまでのみ保持可能
- **用途**: ボスディレクトリへのアクセス
- **ワールドリセット**: 新ワールド移行時に鍵は失う

#### ボスディレクトリ
- **特別な見た目**: 他のディレクトリと区別可能な表示
- **アクセス制御**: 鍵なしアクセス時はUnix風エラーメッセージ
- **配置場所**: 各ワールドの最深部に確実に配置

### マップ・探索システム
- **ファイルシステム構造**: プロジェクトディレクトリ風の階層構造マップ
- **自動生成**: ランダムなディレクトリ・ファイル構造を生成
- **ナビゲーション**: `cd`, `ls`, `pwd`, `tree` コマンドで移動・探索
- **位置情報**: 現在位置をパス形式で表示 (`/projects/web-app/src/components/`)

#### マップ要素
- **モンスター** 🐛: ファイル内に潜む敵（`.js`, `.ts`, `.py` 等のファイル）
- **宝箱** 📦: ランダム装備を含む (`package.json`, `config.json` 等)
- **ランダムイベント** 🎲: 良い事・悪い事がランダム発生 (`CHANGELOG.md`, `TODO.md`, `.env`, `.git/` 等)
- **セーブポイント** 💾: HP/MP全回復 (`README.md`, `docs/` 等)

#### 場所タイプ分類
- **ディレクトリ**: 基本的に安全、内部にランダム要素配置
- **実行ファイル** (`.exe`, `.bin`): 高確率でモンスター
- **設定ファイル** (`.json`, `.yaml`): 宝箱やランダムイベント
- **ドキュメント** (`.md`, `.txt`): セーブポイントやランダムイベント
- **隠しファイル** (`.`で始まる): ランダムイベント（悪い事の確率高）
- **システムファイル** (`.git/`, `.env`): ランダムイベント（悪い事メイン）

### エンカウント・相互作用システム
- **ファイル検査**: `cat`, `head`, `file` コマンドで内容を調査
- **相互作用判定**: ファイルタイプに応じた要素が判明
- **確率システム**: 
  - モンスター: 20-80% (ファイルタイプ依存)
  - 宝箱: 10-30% (設定ファイルで高確率)
  - ランダムイベント: 10-40% (ファイルタイプ依存)
  - セーブポイント: 15-25% (ドキュメントで高確率)

#### 探索詳細システム
- **段階的発見**: `ls` → `file` → `cat` の順で詳細が判明
- **危険度表示**: ファイル拡張子や名前から危険度を推測可能
- **探索報酬**: 新エリア発見、隠しファイル発見で経験値獲得
- **記憶システム**: 一度調査したファイルの内容は記憶される

### 装備ドロップシステム
- **敵撃破報酬**: 敵を倒すと確率で英単語装備がドロップ
- **宝箱システム**: 宝箱から確実に装備獲得、レアリティが高い
- **レアリティシステム**: Common, Uncommon, Rare, Epic, Legendary の5段階
- **場所ボーナス**: ファイルタイプに応じた専用装備
  - `.js/.ts`: JavaScript/TypeScript関連単語
  - `.py`: Python関連単語  
  - `.md`: ドキュメント関連単語
  - `package.json`: 依存関係関連単語
- **装備発見**: 新しい単語を発見してコレクションに追加

### 装備システム
- 単語は個別のステータスを持つ: `{ attack: number, defense: number, speed: number, accuracy: number, critical: number }`
- 装備効果は装備中の全単語ステータスの合計
- 装備中の単語は有効な英文を構成する必要がある
- 文法検証がダメージ出力に影響
- **レアリティによるステータス倍率**: 高レアリティほど強力なステータス

### 戦闘システム
- プログラミング概念に基づくタイピングチャレンジ
- 難易度レベル: 1単語 (基本) → 1文章 (上級)
- ダメージ = 基本ATK × 速度ボーナス × 精度ボーナス × 文法ボーナス
- タイピング完璧性に基づくクリティカルヒット
- **戦闘勝利**: 敵撃破時にドロップ判定とアイテム獲得
- **場所効果**: ファイルタイプに応じた戦闘ボーナス

### ランダムイベントシステム
発生時に良い事・悪い事がランダムで決定される統合システム

#### **良いイベント（40-60%の確率）**
- **装備発見**: レア装備の発見
- **経験値ボーナス**: 追加経験値獲得
- **ステータスアップ**: 一時的なステータス強化
- **情報入手**: マップのヒントや隠し場所の情報
- **ショートカット発見**: 便利な移動手段の発見

#### **悪いイベント（40-60%の確率）**
- **ダメージ**: HP減少（タイピングで軽減可能）
- **デバフ**: ステータス低下（タイピングで解除可能）
- **迷子**: ランダム移動（タイピングで阻止可能）
- **装備破損**: 装備の一時無効化（タイピングで修復可能）
- **ウイルス感染**: 継続ダメージ（タイピングで除去可能）

#### **タイピング回避システム**
悪いイベント発生時に緊急タイピングチャレンジが開始
- **制限時間**: 10-30秒（イベントの深刻度による）
- **成功条件**: 指定されたプログラミング用語を正確にタイピング
- **完全成功**: 悪影響を完全回避
- **部分成功**: 悪影響を軽減（50-80%カット）
- **失敗**: 悪影響をフルに受ける

### コマンド例
```bash
> start              # ゲーム開始
> pwd                # 現在位置表示
> ls                 # 現在ディレクトリの内容表示
> ls -la             # 隠しファイルも含めて表示
> cd src             # srcディレクトリに移動
> cd ..              # 親ディレクトリに移動
> tree               # ディレクトリツリー表示
> file app.py        # ファイルタイプを調査（要素のヒント）
> cat README.md      # ファイル内容を確認（セーブポイントやイベント）
> head package.json  # ファイルの先頭を確認
> interact app.py    # ファイルと相互作用（戦闘・宝箱・トラップ等）
> save               # セーブポイントでゲーム保存
> battle             # 敵との戦闘開始
> equip 1 the        # スロットに単語を装備
> validate           # 文法チェック
> status             # ステータス表示
> inventory          # 所持単語一覧表示
> collection         # 装備コレクション表示
> drops              # 最近のドロップ履歴表示
> map                # 現在位置周辺のマップ表示
> events             # 発生中/完了済みランダムイベント一覧
```

## テスト実行方法

### 基本テスト実行
```bash
npm test              # 全テスト実行
npm run test:watch    # ウォッチモードでテスト実行
npm run test:coverage # カバレッジレポート付きテスト実行
npm run check         # 包括的品質チェック (Lint + Format + Test)
```

### コード品質チェック
```bash
npm run lint          # ESLintによるコード品質チェック
npm run lint:fix      # ESLint自動修正
npm run format        # Prettierによるコード整形
npm run format:check  # Prettier整形チェック
```

### テストファイル構造
- **src/core/__tests__/**: コアロジックテスト
- **src/commands/__tests__/**: コマンド処理テスト
- **Jest設定**: ESM対応、TypeScript対応、Chalkモック対応
- **ESLint設定**: TypeScript対応、複雑度チェック、コード品質ルール
- **Prettier設定**: 一貫したコードスタイル

### デグレ防止とコード品質保証
- **新機能追加前**: `npm run check` を実行
- **テスト自動実行**: `npm test` 実行前にLint・Formatチェック
- **品質基準維持**: 
  - 全テストが成功することを確認
  - カバレッジが94%以上を維持
  - ESLintエラーが0件
  - Prettierフォーマット準拠

## 重要な指示

### 開発手法：テスト駆動開発 (TDD)
このプロジェクトでは **t-wada (和田卓人氏) が提唱するテスト駆動開発 (Test-Driven Development)** を採用します。

#### TDDサイクル
1. **🔴 Red**: まず失敗するテストを書く
   - 新機能の仕様をテストコードで表現
   - テストが失敗することを確認
2. **🟢 Green**: テストを通す最小限のコードを書く
   - テストが成功する最小限の実装
   - 美しさよりも動作を優先
3. **🔵 Refactor**: コードを改善する
   - テストが通ることを保ちながらリファクタリング
   - 重複排除、可読性向上

#### TDD実践ガイドライン
- **新機能実装前に必ずテストを先に書く**
- **小さなサイクルで素早く回す**
- **テストが失敗→成功→リファクタリングの順序を厳守**
- **テストコードも本体コードと同等に重要視**
- **コード品質を保つためLint・Format チェックを必須とする**

### 開発時の具体的手順
1. **要件定義**: 実装したい機能を明確にする
2. **テスト設計**: 期待する動作をテストコードで表現
3. **Red段階**: 失敗するテストを書いて実行確認
4. **Green段階**: テストを通す最小限のコードを実装
5. **Lint・Format確認**: `npm run lint` と `npm run format:check` を実行
6. **Refactor段階**: 既存テストを維持しながらコード改善
7. **統合確認**: `npm run check` で全品質チェックを実行

### ファイル構成ルール
- コマンド処理は `processor.ts` に追加
- プレイヤーロジックは `player.ts` に追加
- 対応するテストは `__tests__/` ディレクトリ内に配置
- テストファイル名は `*.test.ts` の形式

### コーディング規約
- **コメントは日本語で記述**: コード中のコメント・説明は全て日本語
- **テストは日本語記述**: describe・testメソッドの説明文は日本語
- **クラス名・変数名**: 英語（実装寄りの名前はそのまま）
- **関数の説明**: 日本語コメントで機能を明記

### 品質保証
- **デグレ防止**: 変更後は必ず `npm run check` を実行
- **カバレッジ維持**: 94%以上のコードカバレッジを維持
- **全テスト成功**: 99個全てのテストが成功することを確認
- **コード品質**: ESLintエラー0件、Prettierフォーマット準拠
- **継続的改善**: リファクタリング時もテスト・品質チェックを先に更新
- **自動化**: `npm test` 実行前にLint・Formatチェックを実行