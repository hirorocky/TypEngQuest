# 主要ゲームシステム

## ワールドシステム
このゲームはワールド単位で進行し、各ワールドには鍵が1個、ボス1体が必ず存在します。
ボスを倒す、もしくは、ワールドリタイアすることで、ワールドをリセットし、新しいワールドを生成します。

### ワールドの構造
- **ドメイン**: 各ワールドはドメインを持つ。ドメインはワールドの名前と世界観を表す。ディレクトリや敵、アイテム名に影響
- **階層構造マップ**: 各ワールドはマップを持つ。最大深度を持つファイルシステム風マップ
- **ワールドレベル**: 各ワールドはレベルを持つ。最大深度、敵の強さ、得られるアイテムの強さ、ランダムイベントの効果に影響
- **ボス配置**: 最深部（最大深度）にボスディレクトリが存在
- **鍵システム**: ボスディレクトリへのアクセスには鍵が必要
- **クリア条件**: ボスを倒すとワールドクリア

### ワールド生成アルゴリズム
- **最大深度**: 3 + ワールドレベル（最小4、最大10）
- **ディレクトリ構造**:
  - ルートディレクトリ: ドメイン名（例: tech-startup, game-studio）
  - 各階層のディレクトリ数: 2〜5個（ランダム）
  - ディレクトリ名: ドメインに応じた名前（tech系: src, lib, api等）
- **ファイル配置**:
  - 各ディレクトリのファイル数: 1〜8個
  - ファイルタイプの出現率:
    - モンスター: 40%
    - 宝箱: 25%
    - イベント: 10%
    - セーブポイント: 5%
    - 空ファイル: 20%
  - 隠しファイル率: 10%（グレード+1）
- **特殊配置ルール**:
  - ボスディレクトリ: 最深部に1つ確実に配置
  - 鍵: ボス以外のランダムな宝箱1つに確実に配置
  - セーブポイント: 各階層に最低1つは配置
  - 深い階層ほど強いモンスター・良いアイテムが出現
- **ドメイン例**:
  - tech-startup: src/, api/, config/, tests/
  - game-studio: assets/, scripts/, levels/, builds/
  - web-agency: client/, server/, public/, deploy/

### ワールド進行システム
- **ワールドクリア後の選択**:
  - レベルアップ（難易度上昇）
  - レベル維持（同難易度継続）
  - レベルダウン（難易度軽減）
- **ワールドリタイア**: いつでも現ワールドを破棄して新ワールド生成可能
- **データ引き継ぎ**: 新ワールドに移動するとき、プレイヤーステータス・装備は全て維持、鍵は失う
- **ワールド履歴保存**: 今まで訪れたワールドの、ドメイン、レベル、クリアしたか、日時を保存

### 鍵システム
- **鍵の入手**: 宝箱から取得
- **所持制限**: 1つまでのみ保持可能
- **用途**: ボスディレクトリへのアクセス
- **ワールドリセット**: 新ワールド移行時に鍵は失う

### ボスディレクトリ
- **特別な見た目**: 他のファイルと区別可能な表示
- **アクセス制御**: 鍵なしアクセス時はUnix風エラーメッセージ
- **配置場所**: 各ワールドの最深部に確実に配置
- **ディレクトリの中身**: ボスファイルと比較的良いアイテムが存在

## マップ・探索システム
- **ファイルシステム構造**: プロジェクトディレクトリ風の階層構造マップ
- **自動生成**: ランダムなディレクトリ・ファイル構造を生成
- **ナビゲーション**: `cd`, `ls`, `pwd`, `tree` コマンドで移動・探索
- **位置情報**: 現在位置をパス形式で表示 (`/projects/web-app/src/components/`)

### マップ要素
- **モンスター**: ファイル内に潜む敵（`.js`, `.ts`, `.py` 等のプログラムを書くようなファイル拡張子）
- **宝箱**: ランダムに装備アイテム、消費アイテムを一つ含む (`.yaml`, `.json` 等設定を書くようなファイル拡張子)
- **イベント**: 良い事・悪い事がランダム発生 (`.exe`, `.bin`等の実行ファイルのファイル拡張子)
- **セーブポイント**: HP/MP全回復、セーブができる (`.md`拡張子のみ)
- **隠しファイル**: モンスター、宝箱は`.`で始まることで隠しファイルになる。グレードが上がる。

### セーブシステム
- **セーブデータ保存場所**: `~/.typengquest/saves/`
- **セーブファイル形式**: JSON形式 (`save_<番号>.json`)
- **最大セーブスロット数**: 1~3の3つ
- **オートセーブ**: ワールドクリア時に自動保存（スロット0）

### ファイル作用システム
- **ファイル検査**: `cat`, `head`, `file` コマンドで内容を調査できる
- **相互作用判定**: ファイルタイプに応じてコマンドを使い分け、作用する
  - モンスター (.js, .ts, .py等):
    - `cat <file>`: 戦闘開始
    - `head <file>`: 強さ確認（戦闘なし）
    - `vim <file>` / `nano <file>`: 戦闘開始
  - 宝箱 (.yaml, .json等):
    - `cat <file>`: アイテム取得
    - `head <file>`: 中身のヒント表示
    - `jq . <file>` / `yq . <file>`: アイテム取得
  - イベント (.exe, .bin等):
    - `./<file>`: イベント実行
    - `file <file>`: イベントのヒント表示
    - `chmod +x <file>`: 悪いイベントの効果軽減準備
  - セーブポイント (.md):
    - `cat <file>`: 内容表示とセーブ選択
    - `vim <file>` / `nano <file>`: セーブ実行とHP/MP全回復
- **作用の上限**: 一度作用したファイルは再度作用することはできない（セーブポイントは例外的に何度でも作用できる）

## プレイヤーシステム
- **ステータス**: プレイヤーの基本能力値。HP、MP、strength（攻撃力）、willpower（意志力）、agility（敏捷性）、fortune（幸運）を持つ
- **レベル**: プレイヤーの成長度合いを示す。装備アイテムのグレード平均値。
- **状態**: プレイヤーの現在の状態。バフやデバフ、状態異常、ワールドステータスを持つ。

### ステータス計算式
- **基本HP**: 100 + (レベル × 10)
- **基本MP**: 100 + (レベル × 2)
- **HP/MP仕様**:
  - HP: バトル終了時に最大値まで自動回復。イベント等で上限を超えて回復可能
  - MP: バトル終了時に0にリセット。スキルで消費
- **ダメージ計算**:
  - スキル効果への3層成功率システム採用
  - 第1層: スキル全体の成功率（タイピング評価のみ）
    - 最終成功率は0%〜200%の範囲で補正
  - 第2層: 各効果の成功率（固定値）
  - 第3層: 効果の威力計算（strength/willpower/agility/fortuneいずれかが影響）
  - 影響後威力 = 技の基本威力 × (1 + (影響パラメータ値 × 影響率) / 100)
  - クリティカル率 = スキル基本クリティカル率（上限100%）
  - 最終ダメージ = 影響後威力 × (クリティカル時: 1.5倍)
- **各ステータスの効果**:
  - **strength**: 攻撃スキルのダメージに影響
  - **willpower**: 回復スキル、デバフスキル、一時ステータス回復・継続速度に影響
  - **agility**: 行動ポイント、先手判定、タイピング系ボーナスに影響
  - **fortune**: アイテムドロップ率、状態異常成功率などに影響（クリティカル率には影響しない）
- **アイテムドロップ率**:
  - 基本ドロップ率 = 30 + (fortune / 10) + (ワールドレベル × 5)%
  - 最大80%、最小30%

## アイテムシステム

### アイテムの種類
- **消費アイテム**
- **装備アイテム**
- **だいじなもの**

### 消費アイテム
- **基本回復系**
  - **ライフポーション**: HPを回復するアイテム
  - **マナポーション**: MPを回復するアイテム
  - **オーバーヒールポーション**: HPを最大値を超えて回復
- **バフ系**
  - **ストレングスバフ**: 攻撃力一時アップ
  - **ウィルパワーバフ**: 意志力一時アップ  
  - **アジリティバフ**: 敏捷性一時アップ
  - **フォーチュンバフ**: 幸運一時アップ
- **状態回復系**
  - **状態異常回復**: 全状態異常を回復
  - **一時無敵**: 短時間無敵状態
- **特殊系**
  - **EXポイント回復**: EX Pointを回復

### 装備アイテム
名前は全て英単語。同じ名前でも性能が異なるので、分けて管理する。
最大で100個所持できる。
詳細は装備システムを参照。

### だいじなもの
- **鍵**: ボスディレクトリへのアクセスに必要
- **ボスドロップ**: 倒したボスの名前に応じた特別なアイテム
- **システム解放アイテム**: 新機能を段階的に解放
  - **Combat Manual**: Combo Boost解放
  - **Focus Meditation Scroll**: Focus Mode + EX Point解放
  - **Spark Technique Manual**: Spark Mode解放
  - **Accessory Mastery Ring**: 2個目のアクセサリスロット解放
  - **Skill Mastery Tome 1-4**: 各グレードのスキル解放

## 装備システム
### 装備スロット構成（最大8スロット）
- **形容詞 + 武器1**（2スロット）
- **形容詞 + 武器2**（2スロット）  
- **形容詞 + アクセサリー1**（2スロット）
- **形容詞 + アクセサリー2**（2スロット）

### アイテム種別
- **武器**: strength、willpower寄りのステータス
- **アクセサリー**: agility、fortune寄りのステータス
- **形容詞**: バランス型ステータス

### 装備システムの特徴
- **グレードシステム**: 1-100の数値、レアリティは廃止
- **スキル付与**: 装備アイテムに最大2個のスキルがランダム付与
- **コンボブーストシステム**: 次のスキルを強化する効果をランダム付与
- **段階的解放**: キーアイテムによりシステムが段階的に解放
- **プレイヤーレベル**: 装備グレードの平均値（小数点切り捨て）

### スキルの柔軟性
- **グレード3以上**: 潜在効果（タイピング最高評価時に追加効果）
- **効果発動条件**: HP閾値、敵の状態異常、自身のバフ状態等
- **Combo Boost**: 次スキル強化（ダメージ+10%、回復量+10%等）

## タイピングチャレンジ
- 指定された単語、文（お題）をタイピングする、リアルタイムなチャレンジ
- チャレンジには難易度があり、難易度に応じて単語の長さや文の複雑さが変化
  - 難易度レベル: 1単語 (基本) → 1文章 (上級)
- タイピングの速度と精度を測定し、結果を評価

### 難易度設定
- **難易度1 (最低)**: 3-5文字の単語 (例: "cat", "help", "run")
- **難易度2 (低)**: 6-8文字の単語 (例: "attack", "defense", "escape")
- **難易度3 (中)**: 9-12文字の単語 (例: "programming", "javascript")
- **難易度4 (高)**: 短い文章 (例: "quick brown fox")
- **難易度5 (最高)**: 複雑な文章 (例: "The quick brown fox jumps over the lazy dog")

### タイピング評価
- **制限時間**: 基本10秒 + (難易度レベル × 5秒)
- **速度評価**: Fast(制限時間の70%以下), Normal(85%以下), Slow(制限時間以内), Miss(制限時間超過)
- **精度評価**: Perfect(100%), Good(95%以上), Poor(94%以下)
- **総合評価**: 速度と精度の組み合わせでスキル成功率にボーナス
  - Fast+Perfect: ボーナス35
  - Fast+Good: ボーナス25
  - Normal+Perfect: ボーナス30
  - その他組み合わせは段階的に減少

### タイピングフェーズの実装
- Enterキー不要の文字入力受付
- リアルタイムで入力進捗を表示
- 誤入力時は赤色表示で即座にフィードバック
- バックスペースで訂正可能
- 残り時間のカウントダウン表示

## 戦闘システム
- **ターン制バトル**: プレイヤーと敵が交互に行動
- **行動選択**: プレイヤーは「技使用」「アイテム使用」「逃走」を選択
  - **技使用**: タイピングチャレンジを行い、技を発動させる
  - **アイテム使用**: 消費アイテムを使用してHP/MPを回復する（タイピングチャレンジは行わない）
  - **逃走**: タイピングチャレンジを行い、戦闘から離脱を試みる（成功率は速度と精度に依存）
- **勝敗チェック**: プレイヤー、敵ターン終了時、両者のHPをチェック
  - プレイヤーHPが0以下: ゲームオーバー
  - 敵HPが0以下: 敵撃破
- **撃破後**: 敵撃破時にドロップ判定(ワールドレベルとfortuneがドロップ率に影響)、アイテム獲得

### 新スキル実行システム
- **スキル種別**: 物理/魔法の2種類
- **敵の回避システム**: 敵は物理回避率・魔法回避率を持つ
- **敵行動予告**: 敵の次回使用スキルが事前に表示される
- **MPシステム**: 敵にMP概念なし、スキルのコストは無制限

### EX Pointシステム
- **EX Point獲得**: タイピング難易度 × タイピング評価で獲得
- **Focus Mode**: 全スキルの行動コスト1、MPコスト0、タイピング難易度最低、1ミスでターン終了
- **Spark Mode**: 1スキル選択、1文字ずつタイピング、成功数分だけ連続発動

## ランダムイベントシステム
発生時に良い事・悪い事がランダムで決定される

### 良いイベント
- **アイテム発見**: 消費アイテム、装備アイテムの発見
- **ステータスアップ**: 一時的なステータス強化、そのワールドでのプレイ中だけ有効
- **情報入手**: 鍵orボスの絶対パスが判明

### 悪いイベント
以下は全て、タイピングチャレンジ(難易度: 最低)で回避・軽減可能
- **ダメージ**: HP減少（1未満にならない）
- **デバフ**: ステータス低下
- **迷子**: ランダムで移動
- **ウイルス感染**: 状態異常

## CLIインターフェイス
ゲームはCLIインターフェイスを採用し、プレイヤーはbash風のコマンドで操作を行う。
ゲームにはフェーズが存在し、それぞれのフェーズで使えるコマンドが異なる。

### フェーズの種類
- **タイトル**: ゲームの開始、セーブデータのロード、ゲーム終了を行える
- **マップ探索**: ゲームの通常状態。ディレクトリ間を移動したり、ファイルに作用したりできる
- **ダイアログ**: システムとの応答の状態。基本はyesかno
- **インベントリ**: 消費アイテムの消費、装備の変更を行える
- **バトル**: 技の使用（タイピングチャレンジ）、消費アイテムの消費、逃走を行える
- **タイピングチャレンジ**: リアルタイムにタイピングを行う特殊なフェーズ。Enterを押さなくても、入力をそのままタイピングとして認識する

### フェーズ共通
```bash
help      # 利用可能な全コマンドを表示
history   # コマンド履歴を表示
clear     # 画面をクリア
```

### タイトルフェーズ
```bash
start      # ゲーム新規開始
load       # セーブデータをロード
exit       # ゲーム終了
```

### マップ探索フェーズ
```bash
pwd           # 現在位置表示
ls            # 現在ディレクトリの内容表示
ls -a         # 隠しファイルも表示
ls -l         # 詳細情報表示
ls -la        # 隠しファイル + 詳細情報表示
cd <path>     # 指定パスに移動
cd ..         # 親ディレクトリに移動
cd ~          # ルートディレクトリに移動
cd            # ルートディレクトリに移動（引数なし）
pwd           # 現在位置表示
tree          # ディレクトリツリー表示
find <name>   # ファイル・ディレクトリ検索
file <name>   # ファイルタイプ調査（モンスターor宝箱orイベントorセーブポイント）
cat <file>    # ファイル作用（モンスター:戦闘、宝箱:取得、セーブ:選択）
head <file>   # ファイル確認（戦闘なし、ヒント表示）
vim <file>    # エディタ起動（モンスター:戦闘、セーブ:保存）
nano <file>   # エディタ起動（モンスター:戦闘、セーブ:保存）
jq . <file>   # JSONファイル操作（宝箱開封）
yq . <file>   # YAMLファイル操作（宝箱開封）
./<file>      # 実行ファイル起動（イベント発動）
chmod +x <file> # 実行権限付与（イベント準備）
inventory     # インベントリフェーズへ移行
status        # プレイヤーステータスと装備ボーナスを表示
retire        # ワールドリタイア（新ワールド生成）
```

### ダイアログフェーズ
```bash
yes           # yesと応答
no            # noと応答
```
### インベントリフェーズ
```bash
ls                  # インベントリ内のアイテム一覧表示
use <item>          # 指定アイテムを使用（消費アイテム)
equip <slot> <word> # スロットに単語を装備
unequip <slot>      # スロットから単語を削除
status              # プレイヤーステータスと装備ボーナスを表示
equipments          # 装備中の単語と現在の文章を表示
exit                # マップ探索フェーズに戻る
```

### バトルフェーズ
```bash
status        # プレイヤーステータスと装備ボーナスを表示
skill <skill> # 技を使用（タイピングチャレンジフェーズ）
skills        # 使用可能な技一覧表示
use <item>    # 消費アイテムを使用
items         # 消費アイテム一覧表示
run           # 逃走を試みる（タイピングチャレンジフェーズ）
```

### 操作性
- 方向キーの上下でコマンド履歴を参照
- tabキーでコマンド補完
- 入力中に`Ctrl+C`で入力中のコマンドを全消去
