# 開発に関する指示

## 開発手法：テスト駆動開発 (TDD)
このプロジェクトでは **t-wada (和田卓人氏) が提唱するテスト駆動開発 (Test-Driven Development)** を採用します。

### TDDサイクル
1. **🔴 Red**: まず失敗するテストを書く
   - 新機能の仕様をテストコードで表現
   - テスト実行前にLint・Formatを実行
   - テストが失敗することを確認
2. **🟢 Green**: テストを通す最小限のコードを書く
   - 美しさよりも動作を優先してテストが成功する最小限の実装
   - テスト実行前にLint・Format
   - テストが成功することを確認
3. **🔵 Refactor**: コードを改善する
   - テストが通ることを保ちながらリファクタリング
   - 重複排除、可読性向上

### TDD実践ガイドライン
- **新機能実装前に必ずテストを先に書く**
- **小さなサイクルで素早く回す**
- **テストが失敗→成功→リファクタリングの順序を厳守**
- **テストコードも本体コードと同等に重要視**
- **コード品質を保つためLint・Format チェックを必須とする**
- **ランダムな機能はモックを使い、Flakyにならないようにする**

## 開発時の具体的手順
1. **要件定義**: 実装したい機能を明確にする
2. **テスト設計**: 期待する動作をテストコードで表現
3. **Red段階**: 失敗するテストを書いて実行確認
4. **Green段階**: テストを通す最小限のコードを実装
5. **Lint・Format確認**: `npm run lint` と `npm run format:check` を実行
6. **Refactor段階**: 既存テストを維持しながらコード改善
7. **統合確認**: `npm run check` で全品質チェックを実行

## ファイル構成ルール
- コマンド処理は `processor.ts` に追加
- プレイヤーロジックは `player.ts` に追加
- 対応するテストは `__tests__/` ディレクトリ内に配置
- テストファイル名は `*.test.ts` の形式

## コーディング規約
- **コメントは日本語で記述**: コード中のコメント・説明は全て日本語
- **テストは日本語記述**: describe・testメソッドの説明文は日本語
- **クラス名・変数名**: 英語（実装寄りの名前はそのまま）
- **JSDocコメント**: 全てのクラスとメソッドにJSDoc形式のコメントを付与
- **関数の説明**: 日本語コメントで機能を明記

### JSDocコメント規約
- **クラス**: 目的と責務を日本語で説明
- **メソッド**: 機能、引数、戻り値を日本語で説明
- **パラメータ**: 型と説明を明記
- **戻り値**: 型と説明を明記
- **例外**: throwsする場合は条件を明記

```typescript
/**
 * プレイヤークラス - ゲーム内のプレイヤー情報と装備を管理する
 */
export class Player {
  /**
   * プレイヤーのステータスを取得する
   * @param includeEquipment - 装備ボーナスを含めるかどうか
   * @returns プレイヤーのステータス情報
   * @throws {Error} プレイヤーが初期化されていない場合
   */
  getStatus(includeEquipment: boolean = true): PlayerStatus {
    // 実装
  }
}
```

## セーブシステム開発ルール 🔥 **最重要**
新機能追加・状態管理変更時は以下を **必ず** 同期実装：

### 必須作業リスト
1. **セーブデータ型定義更新** (`src/core/saveData.ts`)
   - 新しい状態データの型を`SaveData`インターフェースに追加
   - 既存の型定義と整合性を保つ

2. **セーブ処理更新** (`src/core/saveManager.ts`)
   - `convertXXXData()`メソッドで新状態をセーブデータに変換
   - セーブ時に新しい状態が確実に保存されることを確認

3. **復元処理更新** (`src/core/game.ts`)
   - `restoreXXXState()`メソッドで新状態をメモリに復元
   - ロード時に新しい状態が確実に復元されることを確認

4. **テスト更新**
   - セーブ・ロード・復元の全工程をテストで検証
   - 新機能のセーブデータ互換性をテスト

### 現在の実装制限（要対応）
- ⚠️ **イベントシステム**: バフ・デバフの実際の復元（現在はログのみ）
- ⚠️ **プレイヤー経験値**: 正確な経験値設定（現在はレベル調整のみ）
- ⚠️ **戦闘状態**: 戦闘中状態の完全復元（現在は簡易実装）

### 破綻防止チェック
- セーブ後即座にロードして状態が一致することを確認
- 新機能追加後は必ずセーブ・ロードテストを実行
- バージョン互換性の確認（`saveData.version`チェック）

## 品質保証
- **デグレ防止**: 変更後は必ず `npm run check` を実行
- **カバレッジ維持**: 95%以上のコードカバレッジを維持
- **全テスト成功**: 389個全てのテストが成功することを確認
- **コード品質**: ESLintエラー0件、Prettierフォーマット準拠
- **JSDocコメント**: 全クラス・メソッドに適切なコメントを付与
- **継続的改善**: リファクタリング時もテスト・品質チェックを先に更新
- **自動化**: `npm test` 実行前にLint・Formatチェックを実行、エラーを無視しないこと
- 🔥 **セーブシステム**: 新機能追加時は上記セーブシステム開発ルールを厳守