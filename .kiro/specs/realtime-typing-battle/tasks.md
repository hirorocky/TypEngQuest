# Implementation Plan

## Tasks

- [ ] 1. プロジェクト基盤とアプリケーションエントリーポイント構築
- [x] 1.1 (P) Goプロジェクト初期化とBubbletea/Lipgloss/Bubbles依存関係セットアップ
  - Goモジュール初期化とgo.mod作成
  - Bubbletea、Lipgloss、Bubblesライブラリの依存追加
  - 基本的なディレクトリ構造の作成（cmd、internal、data）
  - _Requirements: 1.1_

- [x] 1.2 (P) ターミナル環境検証とTUI起動処理実装
  - ターミナルサイズ検出（最小120x40要件）
  - サイズ不足時の警告メッセージ表示
  - UTF-8エンコーディング対応確認
  - ターミナルサイズ変更時の再検証または警告処理
  - _Requirements: 1.2, 1.3, 1.4, 19.5_

- [x] 1.3 RootModel実装とゲーム全体状態管理
  - RootModel構造体の定義（GameState、現在シーン管理）
  - Init/Update/Viewの基本メソッド実装
  - シーンルーティングメカニズムの構築
  - 終了操作時のターミナル状態復元処理
  - _Requirements: 1.1, 1.5, 1.6, 1.7_

- [ ] 2. ドメインモデル層実装
- [x] 2.1 (P) コアドメインモデル定義
  - CoreModel構造体（ID、名前、レベル、特性、ステータス、パッシブスキル、許可タグ）
  - CoreType構造体（ステータス重み、パッシブスキルID、最低ドロップレベル）
  - Stats構造体（STR、MAG、SPD、LUK）
  - コアレベルからのステータス計算ロジック
  - _Requirements: 5.3, 5.4, 5.6, 5.9, 5.10, 5.13, 5.14, 5.15, 5.16, 5.17_

- [x] 2.2 (P) モジュールドメインモデル定義
  - ModuleModel構造体（ID、名前、カテゴリ、レベル、タグ、基礎効果、参照ステータス）
  - ModuleCategoryの定義（物理攻撃、魔法攻撃、回復、バフ、デバフ）
  - カテゴリ別のステータス参照ルール定義
  - _Requirements: 6.3, 6.4, 6.8, 6.9, 6.10, 6.11, 6.12, 6.13, 6.14, 6.15, 6.16_

- [x] 2.3 (P) エージェントドメインモデル定義
  - AgentModel構造体（ID、コア、モジュール配列、レベル、基礎ステータス）
  - エージェントレベル = コアレベルの制約実装
  - 基礎ステータス算出ロジック（コアから導出）
  - _Requirements: 7.9, 8.3_

- [x] 2.4 (P) プレイヤードメインモデル定義
  - PlayerModel構造体（HP、最大HP、EffectTable）
  - 最大HP計算ロジック（装備エージェントのコアレベル平均 × HP係数）
  - 装備変更時のHP再計算トリガー
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.7_

- [x] 2.5 (P) 敵ドメインモデル定義
  - EnemyModel構造体（ID、名前、レベル、HP、攻撃力、攻撃間隔、タイプ、フェーズ、EffectTable）
  - EnemyPhase（通常/強化）の定義
  - HP50%以下でのフェーズ変化ルール
  - _Requirements: 11.15, 11.16, 11.17, 13.2, 13.3_

- [x] 2.6 ステータス効果テーブル（EffectTable）実装
  - EffectRow構造体（ID、ソース種別、名前、残り時間、修正値）
  - StatModifiers構造体（基本ステータス加算/乗算、特殊効果）
  - 効果の追加/削除/時限更新メソッド
  - 最終ステータス計算（加算→乗算の順序で適用）
  - _Requirements: 4.5, 4.6, 10.1, 11.28, 11.29, 11.30_

- [ ] 3. データ永続化層実装
- [x] 3.1 (P) 外部データファイルローダー実装
  - コア特性定義のJSONスキーマとロード処理
  - モジュール定義のJSONスキーマとロード処理
  - 敵タイプ定義のJSONスキーマとロード処理
  - タイピング辞書のロード処理
  - スキーマ検証とエラーハンドリング
  - _Requirements: 5.19, 6.18, 11.14, 16.3, 16.4, 21.6, 21.7_

- [x] 3.2 (P) 初期ゲームデータファイル作成
  - cores.json（攻撃バランス、パラディン、オールラウンダー、ヒーラー）
  - modules.json（各カテゴリLv1〜Lv3）
  - enemies.json（最低10種類の敵バリエーション）
  - words.json（英単語、プログラミング用語のデフォルト辞書）
  - _Requirements: 5.14, 5.15, 5.16, 5.17, 5.18, 6.17, 13.4, 16.1, 16.2_

- [x] 3.3 セーブデータI/O実装
  - SaveData構造体（バージョン、タイムスタンプ、プレイヤー、インベントリ、統計、実績、設定）
  - 原子的書き込み処理（一時ファイル → 検証 → リネーム）
  - バックアップローテーション（直近3世代保持）
  - ロード時のバージョンチェックとデータ検証
  - 破損時のバックアップ復元試行
  - _Requirements: 17.1, 17.2, 17.3, 17.4, 17.5, 17.6, 17.7, 17.8, 19.1, 19.2, 19.3_

- [x] 4. インベントリ管理システム実装
- [x] 4.1 (P) コアインベントリ管理
  - コア一覧表示機能
  - コアの追加/削除処理
  - 特性・レベルによるフィルタリング
  - 特性・レベルによるソート
  - インベントリ上限チェック
  - _Requirements: 5.1, 5.2, 5.3, 5.7, 5.8_

- [x] 4.2 (P) モジュールインベントリ管理
  - モジュール一覧表示機能
  - モジュールの追加/削除処理
  - カテゴリ・レベルによるフィルタリング
  - カテゴリ・レベルによるソート
  - インベントリ上限チェック
  - _Requirements: 6.1, 6.2, 6.3, 6.5, 6.6, 6.7_

- [x] 4.3 エージェントインベントリ管理
  - エージェント一覧管理
  - エージェントの追加/削除処理
  - 保有上限チェック（最低20体）
  - 装備中エージェント破棄時の警告処理
  - _Requirements: 7.12, 8.9, 8.10, 20.6_

- [x] 5. エージェント管理システム実装
- [x] 5.1 コア特性とモジュールタグ互換性検証
  - コア特性の許可タグリスト取得
  - モジュールタグとの照合処理
  - 装備可否判定ロジック
  - _Requirements: 5.9, 5.10, 5.11, 5.12_

- [x] 5.2 エージェント合成機能実装
  - コア選択インターフェース
  - 選択コアの許可タグに基づくモジュールフィルタリング
  - モジュール4個選択インターフェース
  - 合成プレビュー（最終ステータス、能力表示）
  - 合成確定処理（素材消費、エージェント作成）
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 7.10, 7.11, 7.13_

- [x] 5.3 エージェント装備機能実装
  - 3スロットの装備管理
  - エージェント装備処理
  - エージェント装備解除処理
  - 装備変更時のプレイヤー最大HP再計算
  - 装備中エージェント詳細表示
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8_

- [x] 6. タイピングシステム実装
- [x] 6.1 タイピングチャレンジ生成
  - モジュール難易度に応じたテキスト長さ決定（弱:3-6文字、中:7-11文字、強:12-20文字）
  - 辞書からのランダム単語選択
  - 連続同一テキスト回避ロジック
  - モジュール別制限時間設定
  - _Requirements: 16.1, 16.2, 16.5, 16.6, 16.7, 16.8, 16.9, 16.10, 16.13_

- [x] 6.2 タイピング評価エンジン実装
  - チャレンジ開始時のタイムスタンプ記録
  - 文字入力の正誤判定
  - 入力進捗の更新
  - WPM計算（正しい文字数 / 完了時間(秒) × 60 / 5）
  - 正確性計算（正しい入力数 / 総入力数）
  - 速度係数計算（基準時間 / 実際時間、上限2.0）
  - 制限時間超過の検出とキャンセル処理
  - _Requirements: 9.7, 9.8, 9.9, 9.10, 10.6, 10.7, 10.8, 16.11, 16.12_

- [x] 7. バトルエンジン実装
- [x] 7.1 バトル初期化処理
  - 指定レベルに基づく敵生成
  - 装備エージェントからのプレイヤーHP設定（全回復）
  - バトル状態の初期化
  - 敵攻撃タイマーの開始（tea.Tick）
  - _Requirements: 9.1, 4.3, 13.1_

- [x] 7.2 敵攻撃システム実装
  - 敵の自動攻撃タイマー管理（tea.Tick継続ループ）
  - 攻撃ダメージ計算（攻撃力 - 防御バフ）
  - プレイヤーHP減少処理
  - 攻撃予告タイマーのリアルタイム表示
  - 次回攻撃の属性と予測ダメージ表示
  - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8, 11.9, 11.10_

- [x] 7.3 敵フェーズ変化と特殊行動実装
  - HP50%以下での強化フェーズ移行判定
  - フェーズ移行時の視覚的変化
  - 自己バフ行動（攻撃力UP、ダメージ軽減）
  - プレイヤーへのデバフ行動（タイピング制限短縮、テキストシャッフル、難易度上昇、クールダウン延長）
  - バフ・デバフの時間管理と効果適用
  - _Requirements: 11.15, 11.16, 11.17, 11.18, 11.19, 11.20, 11.21, 11.22, 11.23, 11.24, 11.25, 11.26, 11.27_

- [x] 7.4 モジュール効果計算システム実装
  - 参照ステータスの取得（STR、MAG、SPD、LUK）
  - 攻撃ダメージ計算（基礎効果 × ステータス × 速度係数 × 正確性係数）
  - 回復量計算（同上の計算式）
  - バフ効果の付与処理
  - デバフ効果の付与処理
  - 正確性50%未満での効果半減ルール
  - 効果量とパフォーマンス表示
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 10.9, 10.10_

- [x] 7.5 バトル勝敗判定と終了処理
  - プレイヤーHP=0での敗北判定
  - 敵HP=0での勝利判定
  - バトル統計記録（WPM、正確性、クリアタイム）
  - 到達最高レベルの更新処理
  - _Requirements: 9.16, 9.17, 3.9_

- [x] 8. ドロップ・報酬システム実装
- [x] 8.1 報酬計算と表示
  - 勝利時の報酬画面表示
  - バトル統計（WPM、正確性、クリアタイム）表示
  - 敗北時の報酬なし直接遷移
  - _Requirements: 12.1, 12.2, 12.3, 12.4_

- [x] 8.2 コアドロップシステム実装
  - ドロップ判定処理
  - コアレベル決定（敵レベル ± 範囲内ランダム）
  - 特性別ドロップ最低敵レベル制限
  - ドロップ情報表示とインベントリ追加
  - _Requirements: 12.5, 12.6, 12.7, 12.8, 12.9, 12.10_

- [x] 8.3 モジュールドロップシステム実装
  - ドロップ判定処理
  - カテゴリ×レベル別ドロップ最低敵レベル制限
  - 高レベルモジュールの段階的ドロップ設定
  - ドロップ情報表示とインベントリ追加
  - _Requirements: 12.11, 12.12, 12.13, 12.14, 12.15, 12.16_

- [x] 8.4 インベントリ満杯時の処理
  - 満杯警告表示
  - 不要アイテム破棄促進
  - 一時保管と後日受け取り機能
  - _Requirements: 12.17, 12.18_

- [x] 9. 敵生成システム実装
- [x] 9.1 敵ステータス計算
  - レベルに応じたHP計算
  - レベルに応じた攻撃力計算
  - レベルに応じた攻撃間隔計算（高レベルほど短い間隔）
  - _Requirements: 13.2, 20.2, 20.3, 20.4_

- [x] 9.2 敵バリエーションとレベル上限
  - 敵タイプからのランダム選択
  - 同レベルでの複数バリエーション対応
  - レベル上限（100）の設定
  - 最高レベル敵撃破時のゲームクリア演出
  - _Requirements: 13.4, 13.5, 13.6, 13.7, 13.8, 20.8_

- [ ] 10. UI/画面実装
- [ ] 10.1 ホーム画面実装
  - 4つの主要機能メニュー表示（エージェント管理、バトル選択、図鑑、統計/実績）
  - 矢印キー/hjklによるメニュー選択
  - Enterキーによる項目実行
  - 現在の進行状況表示（到達最高レベル、装備中エージェント）
  - 設定画面へのアクセス
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10, 21.1_

- [ ] 10.2 バトル選択画面実装
  - レベル番号入力欄表示
  - 到達最高レベルと挑戦可能最大レベル表示
  - 入力値の検証（1未満、最大レベル超過）
  - 確認画面（レベル番号、予想敵情報）表示
  - エージェント未装備時のバトル開始拒否
  - 過去クリアレベルへの再挑戦許可
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.10, 20.1_

- [ ] 10.3 バトル画面実装
  - 敵情報表示（名前、HP、レベル）
  - プレイヤー情報表示（現在HP、最大HP、バフ・デバフ）
  - 装備中エージェントのモジュール一覧（エージェントごとにグループ化）
  - モジュールのクールダウン状態表示（プログレスバー、残り秒数）
  - タイピングチャレンジテキスト表示と入力進捗
  - 制限時間のリアルタイム表示
  - _Requirements: 9.2, 9.3, 9.4, 9.5, 9.6, 9.11, 9.12, 9.13, 9.14, 9.15, 18.9, 18.10_

- [ ] 10.4 エージェント管理画面実装
  - コア一覧サブ画面
  - モジュール一覧サブ画面
  - エージェント合成サブ画面
  - エージェント装備サブ画面
  - 詳細情報表示（選択時）
  - _Requirements: 5.1, 5.2, 5.5, 6.1, 6.2, 7.1, 7.2, 8.1, 8.2_

- [ ] 10.5 図鑑画面実装
  - 3カテゴリ表示（コア図鑑、モジュール図鑑、敵図鑑）
  - コア図鑑（全特性一覧、獲得状況、詳細情報、未獲得シルエット）
  - モジュール図鑑（全タイプ一覧、獲得状況、詳細情報、未獲得シルエット）
  - 敵図鑑（遭遇済み一覧、詳細情報、未遭遇シルエット）
  - コンプリート率表示
  - _Requirements: 14.1, 14.2, 14.3, 14.4, 14.5, 14.6, 14.7, 14.8, 14.9, 14.10, 14.11_

- [ ] 10.6 統計・実績画面実装
  - タイピング統計表示（最高WPM、平均WPM、100%正確性回数、総タイプ文字数）
  - バトル統計表示（総バトル数、勝利数、敗北数、到達最高レベル）
  - 実績一覧（達成済み/未達成の区別）
  - 実績達成通知
  - コンプリート率表示
  - _Requirements: 15.1, 15.2, 15.3, 15.10, 15.11_

- [ ] 10.7 設定画面実装
  - キーバインド設定表示と変更
  - 設定変更の即時適用
  - 設定のファイル保存
  - 起動時の設定ロード
  - _Requirements: 21.2, 21.3, 21.4, 21.5_

- [ ] 11. ビジュアル表現とUI/UX実装
- [ ] 11.1 (P) 基本スタイリング実装
  - ボックス描画文字によるレイアウト
  - カラー表示（HP色分け：緑/黄/赤、ダメージ：赤、回復：緑）
  - カラー非対応ターミナルでの代替表示
  - HPバーの視覚的表示
  - _Requirements: 18.1, 18.2, 18.3, 18.4_

- [ ] 11.2 (P) アニメーションとフィードバック実装
  - ダメージ発生時のアニメーション効果
  - タイピング入力の色分け（入力中、完了済み、未入力）
  - 重要メッセージの強調表示
  - 画面ちらつき最小化の描画更新
  - _Requirements: 18.5, 18.6, 18.7, 18.8_

- [ ] 12. 実績システム実装
- [ ] 12.1 タイピング実績実装
  - WPMマイルストーン達成判定（50, 80, 100, 120 WPM）
  - 100%正確性クリア実績
  - 実績達成時の通知処理
  - _Requirements: 15.4, 15.5, 15.9_

- [ ] 12.2 バトル実績実装
  - 敵撃破数マイルストーン達成判定（10, 50, 100, 500体）
  - レベルマイルストーン達成判定（10, 25, 50, 100到達）
  - ノーダメージクリア実績
  - _Requirements: 15.6, 15.7, 15.8_

- [ ] 13. エラー処理と安定性確保
- [ ] 13.1 入力検証とエラーハンドリング
  - 不正な入力値の検証
  - エラーメッセージ表示
  - ゲームクラッシュ防止
  - _Requirements: 19.4_

- [ ] 13.2 デバッグモードとログ機能
  - デバッグモード切り替え
  - エラー詳細のログファイル記録
  - 予期しない例外のキャッチと通知
  - _Requirements: 19.3, 19.6_

- [ ] 14. 初回起動フローと初期エージェント提供
- [ ] 14.1 新規ゲーム初期化
  - セーブデータ不在時の新規ゲーム開始
  - 初期コアの提供（レベル1、オールラウンダー）
  - 初期モジュールの提供（各カテゴリLv1を4個）
  - 初期エージェント自動合成と装備
  - _Requirements: 3.8, 17.5_

- [ ] 15. 統合テストとE2Eテスト
- [ ] 15.1 ドメインモデル単体テスト
  - コア/モジュール/エージェント/敵モデルのテスト
  - ステータス計算のテスト
  - 効果テーブル計算のテスト
  - _Requirements: 5.3, 6.3, 7.9, 10.2, 10.3_

- [ ] 15.2 バトルフロー統合テスト
  - バトル初期化 → 敵攻撃 → モジュール使用 → 効果適用 → 勝敗判定
  - タイピングチャレンジ → 完了 → 効果計算
  - _Requirements: 9.1, 9.16, 9.17, 10.2, 10.3_

- [ ] 15.3 セーブ/ロードフロー統合テスト
  - セーブデータ書き込み → ロード → 整合性確認
  - 破損データ検出 → バックアップ復元
  - _Requirements: 17.3, 17.4, 17.5, 19.2_

- [ ] 15.4 ゲームループE2Eテスト
  - 起動 → ホーム → バトル選択 → バトル → 勝利 → 報酬 → エージェント合成 → 装備 → 次バトル
  - セーブ → 終了 → 再起動 → ロード → 状態確認
  - _Requirements: 1.1, 2.1, 3.7, 12.1, 17.5_

- [ ] 16. 最終統合とゲームバランス調整
- [ ] 16.1 全コンポーネント統合
  - 全画面のシーンルーティング接続
  - ゲーム状態のグローバル管理確認
  - セーブ/ロードタイミングの最終調整
  - _Requirements: 1.5, 2.9_

- [ ] 16.2 ゲームバランスパラメータ調整
  - HP係数の調整
  - 敵攻撃力/間隔のスケーリング確認
  - ドロップ確率の調整
  - チャレンジテキスト長さと制限時間のバランス
  - _Requirements: 20.1, 20.2, 20.3, 20.4, 20.5, 20.7_

## Requirements Coverage Matrix

| Requirement | Tasks |
|-------------|-------|
| 1 | 1.1, 1.2, 1.3 |
| 2 | 10.1 |
| 3 | 10.2 |
| 4 | 2.4, 2.6, 7.4 |
| 5 | 2.1, 3.1, 3.2, 4.1, 5.1, 10.4 |
| 6 | 2.2, 3.1, 3.2, 4.2, 10.4 |
| 7 | 2.3, 4.3, 5.2, 10.4 |
| 8 | 2.3, 4.3, 5.3, 10.4 |
| 9 | 6.2, 7.1, 7.5, 10.3, 15.2 |
| 10 | 2.6, 6.2, 7.4, 15.1, 15.2 |
| 11 | 2.5, 2.6, 3.1, 7.2, 7.3 |
| 12 | 8.1, 8.2, 8.3, 8.4 |
| 13 | 2.5, 3.2, 9.1, 9.2 |
| 14 | 10.5 |
| 15 | 10.6, 12.1, 12.2 |
| 16 | 3.2, 6.1, 6.2 |
| 17 | 3.3, 14.1, 15.3 |
| 18 | 10.3, 11.1, 11.2 |
| 19 | 1.2, 3.3, 13.1, 13.2 |
| 20 | 4.3, 9.1, 9.2, 10.2, 16.2 |
| 21 | 3.1, 10.1, 10.7 |
