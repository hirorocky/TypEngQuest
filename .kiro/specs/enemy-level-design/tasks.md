# Implementation Plan

## Tasks

- [ ] 1. ドメイン層の敵タイプ拡張
- [x] 1.1 (P) 敵の行動データ構造を定義する
  - 行動タイプ（攻撃、自己バフ、プレイヤーデバフ）を列挙型として定義
  - 攻撃行動用のフィールド（物理/魔法の属性）を追加
  - バフ/デバフ行動用のフィールド（効果種別、効果値、持続時間）を追加
  - _Requirements: 3.1, 3.3_

- [x] 1.2 (P) 敵パッシブスキルのデータ構造を定義する
  - パッシブスキル識別子、名前、説明を保持する構造を追加
  - 効果マップ（EffectColumnをキー、float64を値）でEffectTableと連携する形式を定義
  - EffectTableに登録可能なEffectEntryへの変換メソッドを実装
  - _Requirements: 4.1, 4.4_

- [ ] 1.3 敵タイプに新規フィールドを追加する
  - デフォルトレベル（1〜100）フィールドを追加
  - 通常行動パターンと強化行動パターンの配列フィールドを追加
  - 通常パッシブと強化パッシブのフィールドを追加
  - ドロップアイテム設定（カテゴリとTypeID）フィールドを追加
  - JSONマスタデータ形式の拡張（enemies.jsonのスキーマ変更）
  - 行動パターンが空の場合のバリデーション（最低1つの行動を保証）
  - _Requirements: 1.1, 1.2, 2.1, 3.1, 3.3, 4.1, 4.4, 5.2_

- [ ] 1.4 敵インスタンスに行動管理機能を追加する
  - 現在の行動パターンインデックスを保持するフィールドを追加
  - 適用中パッシブスキルIDを保持するフィールドを追加
  - 現在実行すべき行動を取得するメソッドを実装
  - 行動インデックスを進める（ループ対応）メソッドを実装
  - フェーズに応じた行動パターンを返すメソッドを実装
  - _Requirements: 3.2, 3.5_

- [ ] 1.5 **動作確認**: ドメイン層のビルドとテスト
  - `go build ./...` でコンパイルエラーがないことを確認
  - 既存テストが通ることを確認 `go test ./domain/...`
  - 新規追加した構造体のJSONシリアライズ/デシリアライズを手動確認

- [ ] 2. 敵選択UIの実装
- [ ] 2.1 撃破済み敵情報の管理機能を追加する
  - 撃破済み敵情報を提供するインターフェースを定義
  - 敵タイプIDと撃破最高レベルのマップを返す機能を実装
  - ゲーム状態に撃破済み敵情報を保存・読み込みする機能を追加
  - _Requirements: 1.4, 1.5_

- [ ] 2.2 バトル選択画面をカルーセル方式に変更する
  - 既存の入力フィールド方式からカルーセル方式に変更
  - 敵タイプリストと選択インデックスの状態管理を追加
  - レベル選択の状態管理（選択レベル、選択可能範囲）を追加
  - 左右キーで敵種類を変更する操作を実装
  - 上下キーでレベルを変更する操作を実装（撃破済みの場合のみ有効）
  - _Requirements: 1.7, 1.8_

- [ ] 2.3 敵情報パネルの表示機能を実装する
  - 選択中の敵の特徴（名前、HP目安、攻撃属性）を表示
  - 選択中の敵のパッシブスキル名を表示
  - 未撃破敵はデフォルトレベルのみ選択可能であることを視覚的に表示
  - _Requirements: 1.3_

- [ ] 2.4 レベル選択の制約ロジックを実装する
  - 未撃破の敵タイプはデフォルトレベルのみ選択可能にする制約
  - 撃破済み敵はデフォルトレベル以上を選択可能にするロジック
  - バトル開始時に選択したレベルと敵タイプIDを送信するメッセージの拡張
  - _Requirements: 1.4, 1.5_

- [ ] 2.5 **動作確認**: 敵選択UIの手動テスト
  - アプリを起動しバトル選択画面を表示
  - 左右キーで敵種類が切り替わることを確認
  - 未撃破の敵はデフォルトレベルのみ選択可能であることを確認
  - 敵情報パネルに名前、HP目安、パッシブ名が表示されることを確認

- [ ] 3. 敵行動パターン実行ロジックの実装
- [ ] 3.1 パターンベースの敵行動実行機能を実装する
  - 行動パターンに従って順序実行するロジックを実装
  - 攻撃行動の実行（物理/魔法属性に基づくダメージ計算）
  - 自己バフ行動の実行（敵のEffectTableへの効果登録）
  - プレイヤーデバフ行動の実行（プレイヤーのEffectTableへの効果登録）
  - 行動パターンがない場合の既存ランダムロジックへのフォールバック
  - _Requirements: 3.2, 6.2_

- [ ] 3.2 フェーズ遷移時の行動パターン切り替えを実装する
  - HP50%以下での強化フェーズ遷移検知
  - 遷移時に行動インデックスをリセットする処理
  - 強化行動パターンへの切り替え処理
  - 強化行動パターンが空の場合は通常パターン継続
  - _Requirements: 2.2, 2.3, 3.4, 6.1_

- [ ] 3.3 **動作確認**: 敵行動パターンの手動テスト
  - バトルを開始し、敵が行動パターン順に行動することを確認
  - 行動パターンが最後まで到達後、最初に戻ることを確認
  - 攻撃、自己バフ、プレイヤーデバフが正しく実行されることを確認

- [ ] 4. 敵パッシブスキルシステムの実装
- [ ] 4.1 敵パッシブスキルの登録機能を実装する
  - バトル開始時に通常パッシブをEffectTableに登録する処理
  - 一時ステータス修正として効果を適用するロジック
  - パッシブ未設定の場合のスキップ処理
  - _Requirements: 4.2, 6.3_

- [ ] 4.2 フェーズ遷移時のパッシブ切り替え機能を実装する
  - 強化フェーズ遷移時に通常パッシブを無効化する処理
  - 強化パッシブを新たに登録する処理
  - EffectTableからの効果削除と追加の連携
  - _Requirements: 4.3, 4.5, 6.3_

- [ ] 4.3 **動作確認**: パッシブスキルの手動テスト
  - バトル開始時に通常パッシブが適用されていることを確認（ステータス表示）
  - 敵HPが50%以下になった時に強化状態に遷移することを確認
  - 強化状態で通常パッシブが無効化、強化パッシブが有効化されることを確認

- [ ] 5. 確定報酬システムの実装
- [ ] 5.1 確定ドロップの基本ロジックを実装する
  - 敵撃破時に必ず1つのアイテムをドロップする保証
  - 敵タイプのDropItemCategoryとDropItemTypeIDに基づくアイテム決定
  - ドロップ設定がない場合の既存確率ドロップへのフォールバック
  - _Requirements: 5.1, 5.2, 6.4_

- [ ] 5.2 (P) コアドロップの品質計算を実装する
  - 指定TypeIDのコアを生成するロジック
  - 敵レベル以下でランダムにレベルを決定する処理
  - 高レベル敵ほど高レベルコアの確率を上げる重み付け
  - _Requirements: 5.3, 1.6_

- [ ] 5.3 (P) モジュールドロップの品質計算を実装する
  - 指定TypeIDのモジュールを生成するロジック
  - 敵レベルに応じたチェイン効果の選択ロジック
  - 高レベル敵ほど高品質チェイン効果の確率を上げる重み付け
  - _Requirements: 5.4, 1.6_

- [ ] 5.4 **動作確認**: 報酬システムの手動テスト
  - 敵を撃破し、必ず1つのアイテムがドロップすることを確認
  - ドロップアイテムが敵タイプに設定されたカテゴリ（コア/モジュール）であることを確認
  - コアの場合、レベルが敵レベル以下であることを確認
  - モジュールの場合、チェイン効果が付与されていることを確認

- [ ] 6. バトルシステム統合
- [ ] 6.1 敵生成フローの統合
  - 敵タイプ指定での敵生成をサポート
  - 新フィールド（行動パターン、パッシブ）を持つ敵タイプからの生成対応
  - 生成時にActionIndexを0に初期化
  - 選択画面から渡されるEnemyTypeIDの受け渡し
  - _Requirements: 1.1_

- [ ] 6.2 バトル進行ロジックの統合
  - 既存のランダム行動決定をパターンベース実行に置き換え
  - フェーズ遷移検知とパッシブ切り替えの呼び出し
  - バトル終了時の確定報酬システム呼び出し
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 6.3 **動作確認**: 全体フローの手動テスト
  - 敵選択→バトル開始→敵行動→パッシブ→撃破→報酬の一連フローを確認
  - 撃破後、撃破済み敵のレベルを上げて再挑戦できることを確認
  - 高レベルでの報酬品質が向上していることを確認

- [ ] 7. テストとバリデーション
- [ ] 7.1 (P) ドメイン層のユニットテストを実装する
  - EnemyAction、EnemyPassiveSkillの値オブジェクトテスト
  - EnemyModel.GetCurrentAction、AdvanceActionIndexのテスト
  - 行動パターンループの境界値テスト
  - _Requirements: 3.1, 3.2, 4.1, 4.4_

- [ ] 7.2 (P) UseCase層のユニットテストを実装する
  - 行動パターン実行のテスト（攻撃、バフ、デバフ各種）
  - フェーズ遷移とパッシブ切り替えのテスト
  - 確定ドロップ計算のテスト（コア、モジュール各種）
  - _Requirements: 6.1, 6.2, 6.3, 5.1, 5.3, 5.4_

- [ ] 7.3 統合テストを実装する
  - レベル選択→バトル→報酬の一連フローテスト
  - フェーズ遷移とパッシブ切り替えの連携テスト
  - 撃破記録の永続化と次回選択可能レベルのテスト
  - _Requirements: 1.4, 1.5, 2.2, 2.3, 4.3, 4.5, 5.1_
