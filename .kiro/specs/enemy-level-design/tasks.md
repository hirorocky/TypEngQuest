# Implementation Plan

## Tasks

- [x] 1. ドメイン層の敵タイプ拡張
- [x] 1.1 (P) 敵の行動データ構造を定義する
  - 行動タイプ（攻撃、自己バフ、プレイヤーデバフ）を列挙型として定義
  - 攻撃行動用のフィールド（物理/魔法の属性）を追加
  - バフ/デバフ行動用のフィールド（効果種別、効果値、持続時間）を追加
  - _Requirements: 3.1, 3.3_

- [x] 1.2 (P) 敵パッシブスキルのデータ構造を定義する
  - パッシブスキル識別子、名前、説明を保持する構造を追加
  - 効果マップ（EffectColumnをキー、float64を値）でEffectTableと連携する形式を定義
  - EffectTableに登録可能なEffectEntryへの変換メソッドを実装
  - _Requirements: 4.1, 4.4_

- [x] 1.3 敵タイプに新規フィールドを追加する
  - デフォルトレベル（1〜100）フィールドを追加
  - 通常行動パターンと強化行動パターンの配列フィールドを追加
  - 通常パッシブと強化パッシブのフィールドを追加
  - ドロップアイテム設定（カテゴリとTypeID）フィールドを追加
  - JSONマスタデータ形式の拡張（enemies.jsonのスキーマ変更）
  - 行動パターンが空の場合のバリデーション（最低1つの行動を保証）
  - _Requirements: 1.1, 1.2, 2.1, 3.1, 3.3, 4.1, 4.4, 5.2_

- [x] 1.4 敵インスタンスに行動管理機能を追加する
  - 現在の行動パターンインデックスを保持するフィールドを追加
  - 適用中パッシブスキルIDを保持するフィールドを追加
  - 現在実行すべき行動を取得するメソッドを実装
  - 行動インデックスを進める（ループ対応）メソッドを実装
  - フェーズに応じた行動パターンを返すメソッドを実装
  - _Requirements: 3.2, 3.5_

- [x] 1.5 **動作確認**: ドメイン層のビルドとテスト
  - `go build ./...` でコンパイルエラーがないことを確認
  - 既存テストが通ることを確認 `go test ./domain/...`
  - 新規追加した構造体のJSONシリアライズ/デシリアライズを手動確認

- [x] 2. 敵選択UIの実装
- [x] 2.1 撃破済み敵情報の管理機能を追加する
  - 撃破済み敵情報を提供するインターフェースを定義
  - 敵タイプIDと撃破最高レベルのマップを返す機能を実装
  - ゲーム状態に撃破済み敵情報を保存・読み込みする機能を追加
  - _Requirements: 1.4, 1.5_

- [x] 2.2 バトル選択画面をカルーセル方式に変更する
  - 既存の入力フィールド方式からカルーセル方式に変更
  - 敵タイプリストと選択インデックスの状態管理を追加
  - レベル選択の状態管理（選択レベル、選択可能範囲）を追加
  - 左右キーで敵種類を変更する操作を実装
  - 上下キーでレベルを変更する操作を実装（撃破済みの場合のみ有効）
  - _Requirements: 1.7, 1.8_

- [x] 2.3 敵情報パネルの表示機能を実装する
  - 選択中の敵の特徴（名前、HP目安、攻撃属性）を表示
  - 選択中の敵のパッシブスキル名を表示
  - 未撃破敵はデフォルトレベルのみ選択可能であることを視覚的に表示
  - _Requirements: 1.3_

- [x] 2.4 レベル選択の制約ロジックを実装する
  - 未撃破の敵タイプはデフォルトレベルのみ選択可能にする制約
  - 撃破済み敵はデフォルトレベル以上を選択可能にするロジック
  - バトル開始時に選択したレベルと敵タイプIDを送信するメッセージの拡張
  - _Requirements: 1.4, 1.5_

- [x] 2.5 **動作確認**: 敵選択UIの手動テスト
  - アプリを起動しバトル選択画面を表示
  - 左右キーで敵種類が切り替わることを確認
  - 未撃破の敵はデフォルトレベルのみ選択可能であることを確認
  - 敵情報パネルに名前、HP目安、パッシブ名が表示されることを確認

- [x] 3. 敵行動システムの再設計とチャージシステム実装 (Phase 3.0-3.3)

- [x] 3.0.1 enemy_actions.json スキーマ定義とサンプルデータ作成
  - 行動IDベースのマスタデータ管理に変更
  - 攻撃（物理/魔法）、バフ、デバフ、ディフェンスの4タイプをサポート
  - チャージタイム、ダメージ計算式（a + Lv × b）を導入

- [x] 3.0.2 EnemyActionData ローダー実装
  - internal/infra/masterdata/loader.go に LoadEnemyActions() 追加
  - ToDomain() 変換メソッド実装

- [x] 3.0.3 EnemyAction ドメインモデル拡張
  - ディフェンスタイプ（物理軽減/魔法軽減/デバフ回避）追加
  - チャージタイム、ダメージ計算フィールド追加
  - CalculateDamage() メソッド実装

- [x] 3.0.4 EnemyType の行動パターンをID配列に変更
  - NormalActionPatternIDs, EnhancedActionPatternIDs（[]string）
  - ResolvedNormalActions, ResolvedEnhancedActions（解決済み配列）

- [x] 3.0.5 enemies.json のスキーマ更新
  - 各敵タイプに normal_action_pattern, enhanced_action_pattern 追加

- [x] 3.1 チャージ・ディフェンス状態管理
  - EnemyModel にチャージ状態フィールド追加
  - StartCharging(), GetChargeProgress(), IsChargeComplete() 実装
  - ディフェンス状態管理フィールドとメソッド実装

- [x] 3.2 バトルエンジン対応（チャージ、ディフェンス処理）
  - [x] 3.2.1 パターンベース行動決定をチャージシステムに対応
    - `DeterminePatternBasedAction()` - パターンから次回行動を決定
    - `CalculatePatternDamage()` - ダメージ計算（a + Lv * b）
    - `StartEnemyCharging()` - チャージ開始
    - `ExecuteChargedAction()` - チャージ完了後の行動実行
  - [x] 3.2.2 ディフェンス行動の即時発動処理
    - `ActivateDefense()` - チャージタイム0で即座に発動
    - `CheckDefenseExpired()` - ディフェンス終了チェック
  - [x] 3.2.3 プレイヤー攻撃時のディフェンス軽減適用
    - `ApplyDefenseReduction()` - 物理/魔法軽減の適用
  - [x] 3.2.4 デバフ回避判定の実装
    - `CheckDebuffEvasion()` - デバフ回避ディフェンス中の回避判定

- [x] 3.3 UI チャージ予告表示
  - [x] 3.3.1 チャージ進捗バー表示
    - `getChargingActionDisplay()` - チャージ中の行動表示
    - `renderChargeProgressBar()` - チャージ進捗バーの描画
  - [x] 3.3.2 次行動の予告テキスト（行動タイプ、予測ダメージ等）
    - `getDefensePreviewDisplay()` - ディフェンス予告表示
    - 攻撃/バフ/デバフ/ディフェンスの各タイプに対応
  - [x] 3.3.3 ディフェンス中の状態表示（残り時間）
    - `getDefenseActionDisplay()` - ディフェンス発動中の表示

- [ ] 4. 敵パッシブスキルシステムの実装
- [x] 4.1 敵パッシブスキルの登録機能を実装する
  - バトル開始時に通常パッシブをEffectTableに登録する処理
  - 一時ステータス修正として効果を適用するロジック
  - パッシブ未設定の場合のスキップ処理
  - _Requirements: 4.2, 6.3_

- [x] 4.2 フェーズ遷移時のパッシブ切り替え機能を実装する
  - 強化フェーズ遷移時に通常パッシブを無効化する処理
  - 強化パッシブを新たに登録する処理
  - EffectTableからの効果削除と追加の連携
  - _Requirements: 4.3, 4.5, 6.3_

- [ ] 4.3 **動作確認**: パッシブスキルの手動テスト
  - バトル開始時に通常パッシブが適用されていることを確認（ステータス表示）
  - 敵HPが50%以下になった時に強化状態に遷移することを確認
  - 強化状態で通常パッシブが無効化、強化パッシブが有効化されることを確認

- [ ] 5. 確定報酬システムの実装
- [ ] 5.1 確定ドロップの基本ロジックを実装する
  - 敵撃破時に必ず1つのアイテムをドロップする保証
  - 敵タイプのDropItemCategoryとDropItemTypeIDに基づくアイテム決定
  - ドロップ設定がない場合の既存確率ドロップへのフォールバック
  - _Requirements: 5.1, 5.2, 6.4_

- [ ] 5.2 (P) コアドロップの品質計算を実装する
  - 指定TypeIDのコアを生成するロジック
  - 敵レベル以下でランダムにレベルを決定する処理
  - 高レベル敵ほど高レベルコアの確率を上げる重み付け
  - _Requirements: 5.3, 1.6_

- [ ] 5.3 (P) モジュールドロップの品質計算を実装する
  - 指定TypeIDのモジュールを生成するロジック
  - 敵レベルに応じたチェイン効果の選択ロジック
  - 高レベル敵ほど高品質チェイン効果の確率を上げる重み付け
  - _Requirements: 5.4, 1.6_

- [ ] 5.4 **動作確認**: 報酬システムの手動テスト
  - 敵を撃破し、必ず1つのアイテムがドロップすることを確認
  - ドロップアイテムが敵タイプに設定されたカテゴリ（コア/モジュール）であることを確認
  - コアの場合、レベルが敵レベル以下であることを確認
  - モジュールの場合、チェイン効果が付与されていることを確認

- [ ] 6. バトルシステム統合
- [ ] 6.1 敵生成フローの統合
  - 敵タイプ指定での敵生成をサポート
  - 新フィールド（行動パターン、パッシブ）を持つ敵タイプからの生成対応
  - 生成時にActionIndexを0に初期化
  - 選択画面から渡されるEnemyTypeIDの受け渡し
  - _Requirements: 1.1_

- [ ] 6.2 バトル進行ロジックの統合
  - 既存のランダム行動決定をパターンベース実行に置き換え
  - フェーズ遷移検知とパッシブ切り替えの呼び出し
  - バトル終了時の確定報酬システム呼び出し
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 6.3 **動作確認**: 全体フローの手動テスト
  - 敵選択→バトル開始→敵行動→パッシブ→撃破→報酬の一連フローを確認
  - 撃破後、撃破済み敵のレベルを上げて再挑戦できることを確認
  - 高レベルでの報酬品質が向上していることを確認

- [ ] 7. テストとバリデーション
- [ ] 7.1 (P) ドメイン層のユニットテストを実装する
  - EnemyAction、EnemyPassiveSkillの値オブジェクトテスト
  - EnemyModel.GetCurrentAction、AdvanceActionIndexのテスト
  - 行動パターンループの境界値テスト
  - _Requirements: 3.1, 3.2, 4.1, 4.4_

- [ ] 7.2 (P) UseCase層のユニットテストを実装する
  - 行動パターン実行のテスト（攻撃、バフ、デバフ各種）
  - フェーズ遷移とパッシブ切り替えのテスト
  - 確定ドロップ計算のテスト（コア、モジュール各種）
  - _Requirements: 6.1, 6.2, 6.3, 5.1, 5.3, 5.4_

- [ ] 7.3 統合テストを実装する
  - レベル選択→バトル→報酬の一連フローテスト
  - フェーズ遷移とパッシブ切り替えの連携テスト
  - 撃破記録の永続化と次回選択可能レベルのテスト
  - _Requirements: 1.4, 1.5, 2.2, 2.3, 4.3, 4.5, 5.1_
