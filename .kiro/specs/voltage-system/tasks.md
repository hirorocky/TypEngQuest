# Implementation Plan

## Tasks

- [ ] 1. Domain層のボルテージフィールド追加
- [x] 1.1 (P) EnemyModelにボルテージ状態を追加
  - 敵インスタンスにボルテージ値（float64）を保持するフィールドを追加
  - ボルテージの取得メソッドを実装（現在のボルテージ値を返す）
  - ボルテージの設定メソッドを実装（新しいボルテージ値を受け取り設定）
  - ダメージ乗算用の倍率取得メソッドを実装（ボルテージ/100の値を返す）
  - 敵生成時にボルテージを100.0に初期化する処理を追加
  - _Requirements: 1.1, 1.2, 2.3_

- [x] 1.2 (P) EnemyTypeにボルテージ上昇率設定を追加
  - 敵タイプ定義に10秒あたりのボルテージ上昇量フィールドを追加
  - 負の値が設定された場合は0として扱うバリデーションを実装
  - _Requirements: 5.1, 5.2_

- [ ] 2. Infra層のマスターデータ対応
- [x] 2.1 (P) enemies.jsonにボルテージ設定フィールドを追加
  - JSONの敵タイプデータ構造にvoltage_rise_per_10sフィールドを追加
  - ToDomain変換時にボルテージ上昇率をドメインモデルに設定
  - フィールド未設定時はデフォルト値（10ポイント/10秒）を適用
  - 値が0の場合はボルテージが上昇しない設定として扱う
  - 既存のenemies.jsonファイルに各敵タイプのボルテージ設定を追加
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 3. UseCase層のボルテージ管理
- [x] 3.1 VoltageManagerの新規作成
  - 時間経過に基づくボルテージ更新ロジックを担当するマネージャーを作成
  - 経過秒数を受け取り、敵のボルテージ上昇率に基づいて新しいボルテージを計算
  - 10秒あたりの上昇量を経過時間で按分して加算
  - ボルテージの上限を999.9%に制限するクランプ処理を実装
  - ボルテージを100%にリセットするメソッドを実装
  - _Requirements: 2.1, 2.4, 6.1, 6.2, 6.3_

- [x] 3.2 BattleEngineへのVoltageManager統合
  - BattleEngineにVoltageManagerを組み込み
  - バトル初期化時にボルテージを100%に設定する処理を追加
  - リトライ時にもボルテージを100%にリセットする処理を確認
  - 既存の効果更新処理（100msごと）でVoltageManagerのUpdateを呼び出し
  - フェーズ遷移時にボルテージをリセットしないことを確認
  - _Requirements: 1.1, 1.3, 6.1, 6.2, 6.3_

- [ ] 3.3 ダメージ計算へのボルテージ乗算統合
  - プレイヤーがダメージを与える際にボルテージ乗算を適用
  - 最終ダメージ = 基礎ダメージ x (ボルテージ / 100) の計算式を実装
  - ボルテージ100%で等倍（x1.0）、150%で1.5倍となることを確認
  - 既存のダメージ計算フローを維持しつつ、最終段階でボルテージ乗算を適用
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 4. TUI層のボルテージ表示
- [ ] 4.1 ボルテージUIコンポーネントの実装
  - バトル画面にボルテージ表示領域を追加
  - 現在のボルテージをパーセント形式で表示（例: VOLTAGE: 150%）
  - 小数点以下を切り捨てた整数パーセントで表示
  - 画面右上にボルテージ表示を配置
  - BattleTickInterval（100ms）ごとにリアルタイム更新
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 4.2 ボルテージの色分け表示
  - ボルテージ値に応じた色分けロジックを実装
  - 100%から149%は通常色（白/ColorSecondary）で表示
  - 150%から199%は警告色（黄色/ColorWarning）で表示
  - 200%以上は危険色（赤/ColorDamage）で表示
  - 既存のカラーパレットを活用
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 5. テストの実装
- [ ] 5.1 (P) Domain層のユニットテスト
  - EnemyModelのボルテージ取得・設定メソッドのテスト
  - ボルテージ初期値100.0の確認テスト
  - GetVoltageMultiplierの変換精度テスト（100.0→1.0、150.0→1.5）
  - EnemyTypeのボルテージ上昇率フィールドのテスト
  - _Requirements: 1.1, 1.2, 2.3, 3.2, 3.3_

- [ ] 5.2 (P) UseCase層のユニットテスト
  - VoltageManager.Updateのボルテージ上昇計算テスト
  - 10秒経過で設定値分のボルテージが上昇することを確認
  - ボルテージ上昇率0の場合に上昇しないことを確認
  - ボルテージ上限999.9%のクランプテスト
  - VoltageManager.Resetの100%リセットテスト
  - BattleEngineのダメージ計算にボルテージ乗算が適用されることを確認
  - _Requirements: 2.1, 2.4, 3.1, 5.4_

- [ ] 5.3 統合テスト
  - バトル初期化からボルテージ上昇までの一連フローのテスト
  - モジュール使用時にボルテージ乗算が適用されるダメージ計算テスト
  - フェーズ遷移時にボルテージが継続することのテスト
  - マスターデータからボルテージ設定が正しく読み込まれることのテスト
  - _Requirements: 1.1, 1.3, 2.1, 3.1, 5.3, 6.1_
